{{/* Custom Hugo Blox: Features with Image Support */}}
{{/* Based on the default features block */}}
{{/* License: https://github.com/HugoBlox/hugo-blox-builder/blob/main/LICENSE.md */}}

{{/* Initialise */}}
{{ $page := .wcPage }}
{{ $block := .wcBlock }}

<div class="row featurette">
  {{ with $block.content.title }}
  <div class="col-md-12 section-heading">
    <h1>{{ . | markdownify | emojify }}</h1>
    {{ if $block.content.subtitle }}<p>{{ $block.content.subtitle | markdownify | emojify }}</p>{{ end }}
  </div>
  {{ end }}

  {{ with $block.content.text }}
  <div class="col-md-12">
    {{ . | emojify | $page.RenderString }}
  </div>
  {{ end }}

  {{ range $block.content.items }}
  {{ $pack := or .icon_pack "fas" }}
  {{ $pack_prefix := $pack }}
  {{ if in (slice "fab" "fas" "far" "fal") $pack }}
    {{ $pack_prefix = "fa" }}
  {{ end }}
  
  {{ if .image }}
    {{/* Feature with image */}}
    <div class="col-12 mb-5">
      <div class="row align-items-center">
        {{ if eq .image_position "left" }}
          {{/* Image on left */}}
          <div class="col-12 col-md-6 mb-4 mb-md-0">
            {{- $image := resources.Get (path.Join "media" .image) -}}
            {{ if $image }}
              {{ $isSVG := eq $image.MediaType.SubType "svg" }}
              {{ if $isSVG -}}
                <img src="{{ $image.RelPermalink }}" alt="{{ .name }}" class="img-fluid">
              {{- else }}
                {{ $legacy_img := $image.Resize "600x" }}
                {{ $img_src := "" }}
                {{ $img_src_set := slice }}
                {{ $widths := slice 1200 800 400 }}

                {{ range $widths }}
                  {{ $src_link := ($image.Resize (printf "%dx" .)).RelPermalink }}
                  {{ if eq $img_src "" }}
                    {{ $img_src = $src_link }}
                  {{ end }}
                  {{ $img_src_set = $img_src_set | append (printf "%s %dw" $src_link .) }}
                {{ end }}
                {{ $img_src_set = delimit $img_src_set "," }}

                <img src="{{ $legacy_img.RelPermalink }}" srcset="{{ $img_src_set }}" width="{{ $image.Width }}" height="{{ $image.Height }}" alt="{{ .name }}" class="img-fluid">
              {{ end }}
            {{ end }}
          </div>
          <div class="col-12 col-md-6">
            <div class="section-subheading">{{ .name | markdownify | emojify }}</div>
            {{ with .description }}<p>{{ . | markdownify | emojify }}</p>{{ end }}
          </div>
        {{ else }}
          {{/* Image on right */}}
          <div class="col-12 col-md-6">
            <div class="section-subheading">{{ .name | markdownify | emojify }}</div>
            {{ with .description }}<p>{{ . | markdownify | emojify }}</p>{{ end }}
          </div>
          <div class="col-12 col-md-6 mb-4 mb-md-0">
            {{- $image := resources.Get (path.Join "media" .image) -}}
            {{ if $image }}
              {{ $isSVG := eq $image.MediaType.SubType "svg" }}
              {{ if $isSVG -}}
                <img src="{{ $image.RelPermalink }}" alt="{{ .name }}" class="img-fluid">
              {{- else }}
                {{ $legacy_img := $image.Resize "600x" }}
                {{ $img_src := "" }}
                {{ $img_src_set := slice }}
                {{ $widths := slice 1200 800 400 }}

                {{ range $widths }}
                  {{ $src_link := ($image.Resize (printf "%dx" .)).RelPermalink }}
                  {{ if eq $img_src "" }}
                    {{ $img_src = $src_link }}
                  {{ end }}
                  {{ $img_src_set = $img_src_set | append (printf "%s %dw" $src_link .) }}
                {{ end }}
                {{ $img_src_set = delimit $img_src_set "," }}

                <img src="{{ $legacy_img.RelPermalink }}" srcset="{{ $img_src_set }}" width="{{ $image.Width }}" height="{{ $image.Height }}" alt="{{ .name }}" class="img-fluid">
              {{ end }}
            {{ end }}
          </div>
        {{ end }}
      </div>
    </div>
  {{ else }}
    {{/* Feature with icon (original behavior) */}}
    <div class="col-12 col-sm-4">
      {{ with .icon }}
      <div class="featurette-icon">
        {{- if eq $pack "emoji" -}}
          {{- . | emojify -}}
        {{- else if eq $pack "custom" -}}
          {{- $svg_icon := resources.Get (printf "media/icons/%s.svg" .) -}}
          {{- if $svg_icon -}}<img src="{{ $svg_icon.RelPermalink }}" alt="{{.}}" class="svg-icon svg-baseline" loading="lazy">{{- end -}}
        {{- else -}}
          <i class="{{ $pack }} {{ $pack_prefix }}-{{ . }}"></i>
        {{- end -}}
      </div>
      {{ end }}
      <div class="section-subheading">{{ .name | markdownify | emojify }}</div>
      {{ with .description }}<p>{{ . | markdownify | emojify }}</p>{{ end }}
    </div>
  {{ end }}
  {{ end }}
</div>
